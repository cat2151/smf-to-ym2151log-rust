Last updated: 2025-11-12

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をYM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換するRust製ツールです。
- 2パス処理アーキテクチャを採用し、MIDI解析から中間イベント生成、最終的なYM2151ログ変換までを堅牢かつ高速に実行します。
- コマンドラインツールとして、また他のRustプロジェクトからライブラリとして利用可能で、広範なMIDIフォーマットと互換性に対応しています。

## 技術スタック
- フロントエンド: 該当なし (本プロジェクトはコマンドラインインターフェースを持つCLIツールであり、Web UIなどのフロントエンドは含みません)
- 音楽・オーディオ:
    - Standard MIDI Files (SMF) 規格: 世界中で広く使われているデジタル楽器の演奏データを記録するためのファイル形式。
    - YM2151 FM音源チップ: ヤマハが開発したFM音源LSIで、多くのアーケードゲームやコンピュータシステムで採用された音源チップのレジスタ制御。
- 開発ツール:
    - Rust: 高い安全性、パフォーマンス、並行性を特徴とするシステムプログラミング言語。
    - Cargo: Rustの公式パッケージマネージャおよびビルドシステム。依存関係の管理、プロジェクトのビルド、テスト実行などを一元的に行います。
    - Git: バージョン管理システム。ソースコードの変更履歴を管理し、複数人での開発を支援します。
- テスト:
    - `cargo test`: Rustに標準搭載されているテストフレームワーク。ユニットテストと統合テストを実行します。
    - `cargo tarpaulin`: Rustプロジェクトのコードカバレッジを測定・レポート生成するためのツール。
- ビルドツール:
    - Cargo: プロジェクトのコンパイル、パッケージ化、およびバイナリのインストールを行います。
- 言語機能:
    - Rustの型システム: コンパイル時に多くのバグを検出する強力な型システムにより、コードの堅牢性と安全性を保証します。
    - ネイティブコンパイル: Rustコードはネイティブバイナリにコンパイルされるため、高い実行パフォーマンスを実現します。
- 自動化・CI/CD:
    - `cargo build`: ソースコードをコンパイルして実行可能なバイナリを生成するコマンド。
    - `cargo install`: ローカルシステムにCLIツールとしてバイナリをインストールするコマンド。
- 開発標準:
    - `cargo fmt`: Rustコードのフォーマットを自動的に統一し、コードスタイルの一貫性を保つツール。
    - `cargo clippy`: Rustコードの共通的なエラー、不適切な書き方、非効率なコードパターンを指摘するLinterツール。
    - `cargo audit`: プロジェクトの依存関係に既知のセキュリティ脆弱性がないかをチェックするツール。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📖 IMPLEMENTATION.md
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
```

## ファイル詳細説明
-   `.gitignore`: Gitによるバージョン管理から除外するファイルやディレクトリを指定します。
-   `Cargo.lock`: プロジェクトの依存関係とその正確なバージョンを記録し、ビルドの再現性を保証します。
-   `Cargo.toml`: Rustプロジェクトのマニフェストファイル。プロジェクト名、バージョン、ライブラリの依存関係、ターゲット設定などを定義します。
-   `IMPLEMENTATION.md`: 本プロジェクトの実装に関する詳細な技術文書。
-   `LICENSE`: 本プロジェクトのソフトウェアライセンス情報が記載されています。
-   `README.ja.md`: プロジェクトの概要、機能、使い方などを日本語で説明するファイルです。
-   `README.md`: プロジェクトの概要、機能、使い方などを英語で説明するメインのファイルです。
-   `_config.yml`: GitHub Pagesなどの静的サイトジェネレータで使用される設定ファイル。
-   `generated-docs/`: `cargo doc` コマンドによって生成される、APIドキュメントなどの成果物が格納されるディレクトリです。
-   `src/`: プロジェクトの主要なRustソースコードが配置されるディレクトリです。
    -   `error.rs`: プロジェクト内で発生する可能性のあるカスタムエラー型と、それらを処理するためのロジックが定義されています。
    -   `lib.rs`: 本プロジェクトのコア機能を提供するライブラリのエントリポイントです。コマンドラインツールだけでなく、他のRustプロジェクトから利用されるAPIを公開します。
    -   `main.rs`: コマンドラインインターフェース（CLI）アプリケーションのエントリポイントです。引数の解析を行い、`lib.rs`で定義されたコア機能を利用してSMFからYM2151ログへの変換処理を実行します。
    -   `src/midi/`: MIDIファイル解析に関連するモジュールが含まれるディレクトリです。
        -   `events.rs`: Standard MIDI Files (SMF) から抽出される様々なMIDIイベント（例：ノートオン、ノートオフ、テンポチェンジなど）のデータ構造を定義します。
        -   `mod.rs`: `midi` モジュールの宣言ファイルです。このモジュール内の他のファイル（`events.rs`, `parser.rs`, `utils.rs`）を外部に公開します。
        -   `parser.rs`: SMFのバイナリデータを読み込み、MIDIイベントのシーケンスにパース（解析）する主要なロジックを実装しています。
        -   `utils.rs`: MIDI関連の補助的な関数やユーティリティ機能を提供します。
    -   `src/ym2151/`: YM2151レジスタログ変換に関連するモジュールが含まれるディレクトリです。
        -   `converter.rs`: MIDIイベントからYM2151 FM音源チップのレジスタ書き込みログイベントへの変換ロジックを実装する主要なファイルです。
        -   `events.rs`: YM2151レジスタ書き込みログの各イベント（例：レジスタアドレス、書き込み値、タイムスタンプ）のデータ構造を定義します。
        -   `init.rs`: YM2151チップの初期化に必要なレジスタ設定に関する情報やロジックが含まれています。
        -   `mod.rs`: `ym2151` モジュールの宣言ファイルです。このモジュール内の他のファイル（`converter.rs`, `events.rs`, `init.rs`, `note_table.rs`）を外部に公開します。
        -   `note_table.rs`: MIDIノート番号とYM2151が扱う音高（周波数）やオペレータ設定などをマッピングするためのテーブルや関連ロジックを定義します。
-   `tests/`: プロジェクトのテストコードやテストに用いる補助ファイルが配置されるディレクトリです。
    -   `create_test_midi.py`: プロジェクトのテストで使用するためのサンプルMIDIファイルを自動生成するPythonスクリプトです。
    -   `integration_tests.rs`: プロジェクト全体の機能が連携して正しく動作するかを確認する統合テストコードです。
    -   `test_data/`: 統合テストやその他のテストで使用される、実際のサンプルMIDIファイルが格納されているディレクトリです。

## 関数詳細説明
-   `main()`: (定義場所: `src/main.rs`)
    -   役割: コマンドラインアプリケーションのエントリポイント。
    -   引数: なし (コマンドライン引数は`env::args`などで直接取得)。
    -   戻り値: `Result<(), Box<dyn Error>>` (成功またはエラーを示す)。
    -   機能: コマンドライン引数を解析し、入力MIDIファイルのパスと出力オプションを決定します。その後、`lib.rs`で定義された主要な変換関数を呼び出し、処理の全体フローを制御します。エラーが発生した場合はユーザーに通知し、適切な終了コードでプログラムを終了させます。
-   `smf_to_ym2151_log_convert(midi_path: &Path)`: (定義場所: `src/lib.rs` または関連する公開関数)
    -   役割: Standard MIDI Fileを読み込み、YM2151レジスタログ（JSON）に変換する一連の処理を統括します。
    -   引数: `midi_path`: 変換するMIDIファイルへのパス (`&Path`)。
    -   戻り値: `Result<(), SmfToYm2151LogError>` (成功またはカスタムエラーを示す)。
    -   機能: MIDIファイルをパースし、中間イベントを生成します。その後、中間イベントをYM2151レジスタログに変換し、最終結果をJSON形式でファイルに保存します。この関数はライブラリのメインAPIとして機能します。
-   `parse_midi_file(file_bytes: &[u8])`: (定義場所: `src/midi/parser.rs` または `src/lib.rs` 内のヘルパー)
    -   役割: MIDIファイルの生バイトデータを解析し、内部的なMIDIイベント構造体のリストに変換します。
    -   引数: `file_bytes`: MIDIファイルの生バイトデータ (`&[u8]`)。
    -   戻り値: `Result<Vec<MidiEvent>, MidiParserError>` (パースされたMIDIイベントのリストまたはエラーを示す)。
    -   機能: SMFのヘッダ、トラックチャンクを読み込み、タイムスタンプ、ノートオン/オフ、コントロールチェンジ、テンポチェンジなどの各MIDIイベントを抽出します。
-   `convert_midi_events_to_ym2151_log(midi_events: Vec<MidiEvent>, initial_tempo_bpm: f64, ticks_per_beat: u16)`: (定義場所: `src/ym2151/converter.rs` または `src/lib.rs` 内のヘルパー)
    -   役割: パースされたMIDIイベントのリストを、YM2151レジスタ書き込みログイベントのリストに変換します。
    -   引数:
        -   `midi_events`: パース済みのMIDIイベントのリスト (`Vec<MidiEvent>`)。
        -   `initial_tempo_bpm`: MIDIファイルの初期テンポ (`f64`)。
        -   `ticks_per_beat`: 1拍あたりのティック数 (`u16`)。
    -   戻り値: `Result<Vec<Ym2151Event>, Ym2151ConverterError>` (YM2151イベントのリストまたはエラーを示す)。
    -   機能: MIDIイベントのシーケンスを時間軸に沿って処理し、YM2151チップのレジスタに書き込むべきアドレス、値、そして正確なタイミング（タイムスタンプ）を計算して出力イベントを生成します。これには、MIDIノートをYM2151の周波数情報にマッピングする処理や、テンポチェンジへの対応などが含まれます。
-   `write_json_file<T: Serialize>(data: &T, path: &Path)`: (定義場所: `src/lib.rs` または `src/utils.rs` など)
    -   役割: 指定されたデータをJSON形式でファイルに書き込みます。
    -   引数:
        -   `data`: シリアライズ可能なデータ (`&T`、`T`は`serde::Serialize`トレイトを実装)。
        -   `path`: 書き込むファイルのパス (`&Path`)。
    -   戻り値: `Result<(), io::Error>` (成功またはI/Oエラーを示す)。
    -   機能: 中間イベントや最終的なYM2151ログをJSON形式で整形し、指定されたパスにファイルとして出力します。

## 関数呼び出し階層ツリー
```
関数呼び出し階層は提供された情報からは分析できませんでした。

---
Generated at: 2025-11-12 07:08:08 JST
