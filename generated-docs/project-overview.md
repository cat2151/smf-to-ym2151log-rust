Last updated: 2025-11-16

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をヤマハYM2151 FM音源チップ向けのレジスタ書き込みログ（JSON形式）へ変換するRust製ツールです。
- 型安全性、高パフォーマンス、2パス処理アーキテクチャ、プログラムチェンジ対応を特徴とし、開発者向けのライブラリとしても利用可能です。
- 和音数に基づく静的なYM2151チャンネル割り当てとドラムチャンネル優先戦略を採用し、効率的な音源制御を実現します。

## 技術スタック
- フロントエンド: このプロジェクトはコマンドラインインターフェース (CLI) ールであり、専用のグラフィカルなフロントエンドは持ちません。
- 音楽・オーディオ:
    - **Standard MIDI Files (SMF)**: デジタル楽器やシーケンサーで広く使用される、楽譜データを保存するための標準フォーマット。入力ファイルとして扱われます。
    - **YM2151 FM音源チップ**: ヤマハが開発したFM音源チップ。このプロジェクトの出力は、このチップのレジスタを制御するためのログ形式です。
- 開発ツール:
    - **Rust**: 高い安全性、パフォーマンス、並行性を特徴とするシステムプログラミング言語。プロジェクトの主要な開発言語です。
    - **Cargo**: Rustの公式パッケージマネージャー兼ビルドシステム。依存関係の管理、プロジェクトのビルド、テスト実行、ドキュメント生成などを担当します。
    - **Git**: 分散型バージョン管理システム。プロジェクトのソースコード管理に使用されます。
- テスト:
    - **`cargo test`**: Rustの標準テストフレームワーク。ユニットテストおよび統合テストの実行に使用されます。
    - **`cargo tarpaulin`**: Rustプロジェクトのテストカバレッジを測定し、HTMLレポートなどとして出力するツールです。
- ビルドツール:
    - **Cargo**: 上記の通り、Rustプロジェクトのビルドプロセス全体を管理します。
- 言語機能:
    - **Rustの型システム**: コンパイル時に多くのエラーを捕捉し、メモリ安全性を保証することで堅牢なアプリケーション開発を可能にします。
- 自動化・CI/CD:
    - **`cargo audit`**: プロジェクトの依存関係に既知の脆弱性がないかをチェックするセキュリティツールです。
- 開発標準:
    - **`cargo fmt`**: Rustコードを標準的なスタイルに自動整形するフォーマッター。コードの一貫性を保ちます。
    - **`cargo clippy`**: Rustコードの一般的な間違いや非慣用的な記述を検出するLinter。コード品質の向上を支援します。
    - **テスト駆動開発 (TDD)**: 包括的なユニットテストと統合テストを通じて、コードの信頼性と品質を保証する開発手法です。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📖 IMPLEMENTATION.md
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 21.md
  📖 22.md
  📖 23.md
  📖 25.md
  📖 28.md
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
    📄 tone.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 program_change.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
📁 tones/
  📊 000.json
  📖 README.md
```

## ファイル詳細説明
- **`.gitignore`**: Gitバージョン管理システムが追跡しないファイルやディレクトリのパターンを定義します。
- **`Cargo.lock`**: `Cargo.toml`で指定された依存関係の具体的なバージョンとハッシュ値を記録し、ビルドの再現性を保証します。
- **`Cargo.toml`**: Rustプロジェクトのメタデータ（プロジェクト名、バージョン、作者、依存ライブラリなど）を定義するマニフェストファイルです。
- **`IMPLEMENTATION.md`**: プロジェクトの内部実装の詳細や設計に関するドキュメントです。
- **`LICENSE`**: このプロジェクトが従うライセンス情報が記述されています。
- **`README.ja.md`**: プロジェクトの概要、使い方、機能などを日本語で説明する主要なドキュメントです。
- **`README.md`**: プロジェクトの概要、使い方、機能などを英語で説明する主要なドキュメントです。
- **`_config.yml`**: GitHub Pagesなどの静的サイトジェネレータの設定ファイルです。
- **`generated-docs/`**: `cargo doc`コマンドで生成されるAPIドキュメントが出力されるディレクトリです。
- **`issue-notes/`**: 開発中に発生した課題や検討事項に関する個別のメモを格納するディレクトリです。
- **`src/`**: Rustのソースコードが格納される主要なディレクトリです。
    - **`src/error.rs`**: プロジェクト全体で使用されるカスタムエラー型を定義し、エラーハンドリングを一元化します。
    - **`src/lib.rs`**: ライブラリクレートのエントリポイント。CLIツールとしてだけでなく、他のRustプロジェクトから利用されるための公開APIを定義します。
    - **`src/main.rs`**: 実行可能クレートのエントリポイント。コマンドラインインターフェース (CLI) のロジックと全体的な変換プロセスのオーケストレーションを実装します。
    - **`src/midi/`**: MIDIファイル関連の処理をカプセル化するモジュールです。
        - **`src/midi/events.rs`**: MIDIイベントのデータ構造（ノートオン、ノートオフ、テンポチェンジなど）とそれらを扱うためのロジックを定義します。
        - **`src/midi/mod.rs`**: `midi`モジュールのルートファイルで、このモジュール内のサブモジュール（`events`, `parser`, `utils`）を公開します。
        - **`src/midi/parser.rs`**: Standard MIDI Files (SMF) を読み込み、内部で使用する中間イベント形式にパースするロジックを実装します（パスA）。
        - **`src/midi/utils.rs`**: MIDI関連のヘルパー関数やユーティリティロジックを提供します。
    - **`src/ym2151/`**: YM2151 FM音源チップ関連の処理をカプセル化するモジュールです。
        - **`src/ym2151/converter.rs`**: MIDIイベントをYM2151レジスタ書き込みログ（JSON形式）に変換する主要なロジックを実装します（パスB）。チャンネル割り当て戦略、ボイス管理、プログラムチェンジ処理などが含まれます。
        - **`src/ym2151/events.rs`**: YM2151レジスタ書き込みイベントのデータ構造を定義します。
        - **`src/ym2151/init.rs`**: YM2151チップの初期設定（リセットや基本的なパラメータ設定）に関するレジスタ値を定義します。
        - **`src/ym2151/mod.rs`**: `ym2151`モジュールのルートファイルで、このモジュール内のサブモジュールを公開します。
        - **`src/ym2151/note_table.rs`**: MIDIノート番号とYM2151の周波数パラメータ（F-Number/Block）との間のマッピング（音階テーブル）を管理します。
        - **`src/ym2151/tone.rs`**: YM2151の音色（プログラムチェンジイベントで読み込まれるカスタム音色）に関するデータ構造とロードロジックを定義します。
- **`tests/`**: プロジェクトのテストコードを格納するディレクトリです。
    - **`tests/create_test_midi.py`**: 統合テストで使用するためのMIDIファイルをプログラム的に生成するPythonスクリプトです。
    - **`tests/integration_tests.rs`**: プロジェクトの主要な機能が正しく連携して動作するかを検証する統合テストを実装します。
    - **`tests/test_data/`**: テストで使用される様々な種類のMIDIファイルなどのサンプルデータが格納されています。
- **`tones/`**: MIDIプログラムチェンジイベントに対応するカスタムYM2151音色（トーン）を定義したJSONファイルが格納されるディレクトリです。
    - **`tones/000.json`**: MIDIプログラム0番に対応するデフォルトのYM2151音色定義です。
    - **`tones/README.md`**: `tones`ディレクトリ内のカスタム音色ファイルの命名規則やJSONフォーマットに関する説明が記述されています。

## 関数詳細説明
- **`main()` (src/main.rs)**:
    - **役割**: コマンドラインアプリケーションのエントリポイント。
    - **機能**: コマンドライン引数をパースし、指定されたMIDIファイルの変換処理を開始します。変換の進行状況をコンソールに出力し、最終的な出力ファイルを保存します。
- **`parse_midi_file(file_path: &Path)` (src/midi/parser.rs)**:
    - **役割**: Standard MIDI Files (SMF) を解析し、中間イベントのリストを生成します。
    - **引数**: `file_path` (MIDIファイルへのパス)。
    - **戻り値**: 中間イベントのベクター（またはエラー）。
    - **機能**: MIDIファイルのヘッダー、トラックチャンクを読み込み、タイムスタンプに基づいてノートオン/オフ、テンポチェンジ、プログラムチェンジなどのMIDIイベントを抽出・時系列順に整理します。これが変換プロセスの「パスA」に相当します。
- **`convert_to_ym2151_log(midi_events: Vec<MidiEvent>, config: &Config)` (src/ym2151/converter.rs)**:
    - **役割**: パースされたMIDI中間イベントをYM2151レジスタ書き込みログに変換します。
    - **引数**: `midi_events` (MIDIイベントのリスト), `config` (変換設定)。
    - **戻り値**: YM2151レジスタ書き込みイベントのリスト（JSON形式互換）。
    - **機能**: 提供されたMIDIイベントをYM2151チップの特性に合わせて処理します。これには、和音数に基づくYM2151チャンネルの静的割り当て、ドラムチャンネルの優先処理、ノートのラウンドロビン割り当て、プログラムチェンジイベントに応じた音色の適用などが含まれます。これが変換プロセスの「パスB」に相当します。
- **`load_custom_tone(program_number: u8)` (src/ym2151/tone.rs)**:
    - **役割**: 指定されたMIDIプログラム番号に対応するカスタムYM2151音色（トーン）定義をロードします。
    - **引数**: `program_number` (MIDIプログラムチェンジで指定される0-127の番号)。
    - **戻り値**: ロードされた音色データ（またはデフォルト音色、あるいはエラー）。
    - **機能**: `tones/`ディレクトリから`{program_number:03}.json`形式のファイルを検索し、存在すればそれをパースしてYM2151音色として利用します。ファイルが存在しない場合は、内蔵のデフォルト音色を使用します。
- **`run_conversion(midi_file_path: &Path, output_dir: &Path)` (src/lib.rsまたはsrc/main.rsのヘルパー関数)**:
    - **役割**: MIDIファイルの変換処理全体をオーケストレーションします。
    - **引数**: `midi_file_path` (入力MIDIファイルパス), `output_dir` (出力ディレクトリパス)。
    - **戻り値**: 変換成功を示す結果（またはエラー）。
    - **機能**: `parse_midi_file`を呼び出して中間イベントを取得し、次に`convert_to_ym2151_log`を呼び出してYM2151ログを生成します。生成された中間JSONと最終YM2151ログをそれぞれファイルに保存します。

## 関数呼び出し階層ツリー
```
main()
└── run_conversion(midi_file_path, output_dir)
    ├── parse_midi_file(midi_file_path)
    │   └── (MIDIパースに関連する内部ヘルパー関数群)
    │
    ├── convert_to_ym2151_log(midi_events, config)
    │   ├── load_custom_tone(program_number)
    │   │   └── (JSONパース、ファイルI/Oに関連するヘルパー関数)
    │   └── (YM2151レジスタ設定、チャンネル管理、ノート周波数変換に関連する内部ヘルパー関数群)
    │
    └── (ファイル書き込み処理)

---
Generated at: 2025-11-16 07:06:22 JST
