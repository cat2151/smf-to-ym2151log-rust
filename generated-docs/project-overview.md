Last updated: 2025-11-13

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をヤマハYM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換するRust製ツールです。
- 高性能な2パス処理アーキテクチャを採用し、Rustの型安全性とネイティブコンパイルによる高速な変換処理を実現します。
- SMF Format 0および1に対応し、他のRustプロジェクトから利用可能な堅牢なライブラリAPIも提供します。

## 技術スタック
- フロントエンド: このプロジェクトはコマンドラインツールおよびライブラリであり、特定のフロントエンド技術は使用していません。
- 音楽・オーディオ:
    - **Standard MIDI Files (SMF)**: デジタル楽器やシーケンサー間で音楽データをやり取りするための標準フォーマット。入力ファイルとして使用されます。
    - **YM2151 FM音源チップ**: ヤマハが開発したFM音源チップ。本プロジェクトではこのチップのレジスタ設定をシミュレーションするためのJSONログを出力します。
    - **JSON**: YM2151レジスタへの書き込みログの出力フォーマットとして使用されます。
- 開発ツール:
    - **Rust**: 高速でメモリ安全なシステムプログラミング言語。本プロジェクトの全体がRustで実装されています。
    - **Cargo**: Rustの公式パッケージマネージャーおよびビルドシステム。プロジェクトのビルド、依存関係管理、テスト実行に使用されます。
- テスト:
    - **Rust標準テストフレームワーク**: Rustに組み込まれている単体テストおよび統合テストフレームワーク (`cargo test`コマンドで使用)。
    - **Cargo Tarpaulin**: Rustプロジェクトのコードカバレッジを測定し、HTMLレポートなどを生成するツール。
- ビルドツール:
    - **Cargo**: Rustプロジェクトのビルドプロセス全体を管理します。
- 言語機能:
    - **Rustの型システム**: コンパイル時に厳格な型チェックを行うことで、実行時エラーを防ぎ、堅牢なコードを記述するための基盤となります。
- 自動化・CI/CD: 明示的なCI/CDツールは記載されていませんが、以下の開発標準ツールは通常CI/CDパイプラインに組み込まれます。
- 開発標準:
    - **Cargo fmt**: Rustコードの自動フォーマッター。コードスタイルの一貫性を保ちます。
    - **Cargo clippy**: Rustコードの静的解析Linter。一般的なプログラミングミスや非慣用的なコードパターンを検出します。
    - **Cargo audit**: プロジェクトの依存関係に既知のセキュリティ脆弱性がないかチェックするツール。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📖 IMPLEMENTATION.md
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
```

## ファイル詳細説明
- **`.gitignore`**: Gitによるバージョン管理から除外するファイルやディレクトリ（例: ビルド生成物、一時ファイル）を指定します。
- **`Cargo.lock`**: プロジェクトの依存関係の正確なバージョンを記録し、再現可能なビルドを保証します。
- **`Cargo.toml`**: Rustプロジェクトのマニフェストファイル。プロジェクト名、バージョン、依存関係、ビルド設定などを定義します。
- **`IMPLEMENTATION.md`**: プロジェクトの実装に関する詳細な情報や技術的な決定事項が記述されたドキュメントです。
- **`LICENSE`**: 本プロジェクトのソフトウェアライセンス（利用規約）を記載したファイルです。
- **`README.ja.md`**: プロジェクトの概要、目的、特徴、インストール方法、使い方などを日本語で説明する主要なドキュメントです。
- **`README.md`**: プロジェクトの概要、目的、特徴、インストール方法、使い方などを英語で説明する主要なドキュメントです。
- **`_config.yml`**: GitHub Pagesなど、静的サイトジェネレーターの設定ファイルとして使用されます。
- **`generated-docs/`**: `cargo doc`コマンドによって生成されるAPIドキュメントが格納されるディレクトリです。
- **`src/`**: プロジェクトの主要なソースコードが格納されているディレクトリです。
    - **`error.rs`**: カスタムエラー型とエラー処理ロジックを定義し、堅牢なエラーハンドリングを可能にします。
    - **`lib.rs`**: プロジェクトがライブラリとして使用される際のエントリポイントとなるファイルです。他のRustプロジェクトから呼び出される公開APIを提供します。
    - **`main.rs`**: プロジェクトがコマンドラインツールとして実行される際のエントリポイントとなるファイルです。MIDIファイルの処理と変換のメインロジックを含みます。
    - **`src/midi/`**: Standard MIDI Files (SMF) の解析に関連するモジュール群です。
        - **`events.rs`**: MIDIイベント（例: NoteOn, NoteOff, TempoChange）のデータ構造を定義します。
        - **`mod.rs`**: `src/midi`モジュールの宣言ファイルであり、`events`、`parser`、`utils`といったサブモジュールを外部に公開します。
        - **`parser.rs`**: MIDIファイルを読み込み、内部的な中間イベント表現に解析するロジックを実装します（パスA）。
        - **`utils.rs`**: MIDIデータ処理に役立つヘルパー関数やユーティリティを提供します。
    - **`src/ym2151/`**: YM2151 FM音源チップ向けのレジスタログ変換に関連するモジュール群です。
        - **`converter.rs`**: 中間MIDIイベントをYM2151レジスタ書き込みログのJSON形式に変換する主要ロジックを実装します（パスB）。
        - **`events.rs`**: YM2151のレジスタ操作イベント（例: レジスタアドレス、値、タイミング）のデータ構造を定義します。
        - **`init.rs`**: YM2151チップの初期化設定や関連イベントを定義します。
        - **`mod.rs`**: `src/ym2151`モジュールの宣言ファイルであり、内部のサブモジュールを外部に公開します。
        - **`note_table.rs`**: MIDIノート番号をYM2151チップの周波数設定（F-Number/Block）に変換するためのマッピングテーブルやロジックを提供します。
- **`tests/`**: プロジェクトのテストコードが格納されているディレクトリです。
    - **`create_test_midi.py`**: テストケースとして使用するMIDIファイルをプログラム的に生成するためのPythonスクリプトです。
    - **`integration_tests.rs`**: プロジェクト全体の機能が連携して正しく動作するかを確認する統合テストコードが記述されています。
    - **`tests/test_data/`**: 各種テストに使用されるサンプルMIDIファイルが格納されています。
        - **`multi_channel.mid`**: 複数のMIDIチャンネルを含むテスト用MIDIファイルです。
        - **`multi_track.mid`**: 複数のトラックを含むテスト用MIDIファイルです。
        - **`simple_melody.mid`**: 単純なメロディのテスト用MIDIファイルです。
        - **`tempo_change.mid`**: テンポ変更イベントを含むテスト用MIDIファイルです。

## 関数詳細説明
このプロジェクトはRustで実装されており、複数のモジュールにわたる関数群が協調して動作します。提供された情報からは具体的な関数名、引数、戻り値を特定できませんが、各モジュールの役割から推測される主要な機能を持つ関数について説明します。

- **`main.rs` 内の関数**:
    - **役割**: コマンドラインからの実行時にプログラム全体のエントリポイントとして機能します。
    - **機能**: 入力MIDIファイルパスの解析、ライブラリAPIの呼び出し、変換結果のファイル保存、およびエラーハンドリングを担当します。
- **`lib.rs` 内の公開API関数**:
    - **役割**: 他のRustプロジェクトからライブラリとして利用されるための主要なインターフェースを提供します。
    - **機能**: 通常、MIDIファイルパスを受け取り、解析（パスA）とYM2151ログへの変換（パスB）を一連の流れで実行し、結果としてYM2151レジスタログを返します。
- **`src/midi/parser.rs` 内の解析関数**:
    - **役割**: Standard MIDI Files (SMF) を読み込み、プログラム内部で扱いやすい中間イベント表現に変換します。
    - **機能**: MIDIファイルのヘッダー情報を解析し、トラックデータからNote On/Off、テンポ変更などの各種MIDIイベントを抽出し、時間情報と共に構造化されたデータとして出力します。
- **`src/midi/events.rs` 内のイベント関連関数**:
    - **役割**: MIDIイベントのデータ構造（例: `NoteOnEvent`, `TempoChangeEvent`）を定義し、それらの作成やプロパティへのアクセスを提供します。
    - **機能**: MIDIデータの各要素を型安全に表現するためのコンストラクタやヘルパーメソッドを提供します。
- **`src/ym2151/converter.rs` 内の変換関数**:
    - **役割**: `src/midi/parser.rs` から得られた中間イベントを、YM2151 FM音源チップのレジスタ書き込みログ形式に変換します。
    - **機能**: 各MIDIイベント（特にNote On/Off）を、YM2151の具体的なレジスタアドレス、値、タイミング情報にマッピングし、JSON形式で出力されるイベントリストを生成します。
- **`src/ym2151/events.rs` 内のYM2151イベント関連関数**:
    - **役割**: YM2151レジスタ書き込みイベントのデータ構造を定義し、それらの作成やプロパティへのアクセスを提供します。
    - **機能**: YM2151チップへの各操作を型安全に表現するためのコンストラクタやヘルパーメソッドを提供します。
- **`src/ym2151/note_table.rs` 内の周波数変換関数**:
    - **役割**: MIDIノート番号をYM2151チップが解釈できる周波数設定値（F-NumberおよびBlock）に変換します。
    - **機能**: 音階とYM2151のレジスタ値のマッピングに基づき、正確な音程を生成するための計算ロジックを提供します。
- **`src/error.rs` 内のエラー処理関数**:
    - **役割**: プロジェクト固有のエラー型を定義し、エラー発生時の適切なハンドリングを可能にします。
    - **機能**: ファイル読み込みエラー、MIDI解析エラー、変換エラーなど、さまざまな問題に対するカスタムエラーバリアントとその処理メカニズムを提供します。

## 関数呼び出し階層ツリー
```
メイン実行 (`smf-to-ym2151log-rust` コマンドライン)
└── ライブラリAPI呼び出し (通常は `lib.rs` で公開される変換関数)
    ├── パスA: MIDIファイルの解析 (`src/midi/parser.rs` モジュール内の関数群)
    │   └── MIDIイベント構造体 (`src/midi/events.rs` モジュール内の定義) の生成
    │   └── MIDIユーティリティ関数 (`src/midi/utils.rs` モジュール内の関数) の利用
    └── パスB: YM2151レジスタログへの変換 (`src/ym2151/converter.rs` モジュール内の関数群)
        └── YM2151イベント構造体 (`src/ym2151/events.rs` モジュール内の定義) の生成
        └── MIDIノートからYM2151周波数への変換 (`src/ym2151/note_table.rs` モジュール内の関数)
        └── YM2151初期化処理 (`src/ym2151/init.rs` モジュール内の関数) の適用

---
Generated at: 2025-11-13 07:08:02 JST
