Last updated: 2025-11-26

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) を、YM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換するツールです。
- Rust言語で実装されており、高パフォーマンスと堅牢な型安全性、そして外部からのカスタム音色設定に対応しています。
- MIDIデータを2パスで処理し、中間イベントを生成後、YM2151の特性に合わせた詳細なレジスタ操作ログを出力します。

## 技術スタック
- フロントエンド: このプロジェクトはコマンドラインインターフェース（CLI）ツールであり、特定のフロントエンド技術は使用していません。
- 音楽・オーディオ:
    - **Standard MIDI Files (SMF)**: 入力として利用される標準的な音楽データ形式です。
    - **YM2151 FM音源チップ**: 出力されるレジスタ書き込みログの対象となる、ヤマハ製のFM音源チップです。
- 開発ツール:
    - **Rust**: プロジェクトの主要なプログラミング言語であり、安全性とパフォーマンスに優れています。
    - **Cargo**: Rustの公式ビルドシステムおよびパッケージマネージャーで、依存関係管理、ビルド、テスト実行に利用されます。
    - **Git**: ソースコードのバージョン管理システムとして使用されます。
- テスト:
    - **`cargo test`**: Rustの組み込みテストフレームワークにより、単体テストおよび結合テストを実行します。
    - **`cargo tarpaulin`**: テストカバレッジを測定し、レポートを生成するために使用されます。
- ビルドツール:
    - **Cargo**: Rustプロジェクトのコンパイルと実行可能ファイルの生成を管理します。
- 言語機能:
    - **Rustの型システム**: 堅牢なコンパイル時型チェックにより、メモリ安全性とバグの早期発見を促進します。
- 自動化・CI/CD:
    - **`cargo fmt`**: Rustコードの自動フォーマットを行い、コードスタイルの一貫性を保ちます。
    - **`cargo clippy`**: RustコードのLintチェックを行い、潜在的なバグや非効率なコードを指摘します。
    - **`cargo audit`**: プロジェクトの依存関係に既知のセキュリティ脆弱性がないかをチェックします。
- 開発標準:
    - **`rustfmt`**: コードの自動整形ツールで、プロジェクト全体のコードフォーマットを統一します。
    - **`clippy`**: コード品質を向上させるための静的解析ツールです。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 21.md
  📖 22.md
  📖 23.md
  📖 25.md
  📖 28.md
  📖 30.md
  📖 32.md
  📖 33.md
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
    📄 tone.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 program_change.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
📁 tones/
  📊 000.json
  📖 README.md
```

## ファイル詳細説明
- **`.gitignore`**: Gitのバージョン管理から除外するファイルやディレクトリを指定します。
- **`Cargo.lock`**: プロジェクトのビルド時に使用された全ての依存関係の正確なバージョンを記録し、再現可能なビルドを保証します。
- **`Cargo.toml`**: Rustプロジェクトの宣言ファイルで、プロジェクト名、バージョン、依存関係、ビルド設定などを定義します。
- **`LICENSE`**: プロジェクトのライセンス情報（このソフトウェアの使用条件）が記述されています。
- **`README.ja.md`**: プロジェクトの目的、機能、使用方法などを示す日本語の説明ファイルです。
- **`README.md`**: プロジェクトの目的、機能、使用方法などを示す英語の説明ファイルです。
- **`_config.yml`**: GitHub Pagesなどの静的サイトジェネレータの設定ファイルである可能性があります。
- **`generated-docs/`**: `cargo doc` コマンドなどで生成されたドキュメントが格納されるディレクトリです。
- **`issue-notes/`**: 開発中の課題、調査メモ、または特定のイシューに関連する詳細情報がMarkdown形式で格納されています。
    - `21.md` から `33.md`: それぞれ特定のイシューに関するメモや詳細が記述されていると推測されます。
- **`src/`**: プロジェクトの主要なソースコードが格納されているディレクトリです。
    - **`error.rs`**: カスタムエラー型とエラーハンドリングロジックを定義し、プロジェクト全体で一貫したエラー処理を提供します。
    - **`lib.rs`**: このプロジェクトがライブラリとして利用される際のエントリポイントであり、主要な変換ロジックやAPIが公開されます。
    - **`main.rs`**: コマンドラインインターフェース（CLI）として実行される際のエントリポイントで、`lib.rs` の機能を利用して全体の処理フローを制御します。
    - **`src/midi/`**: MIDIファイルの解析とイベント処理に関連するモジュール群です。
        - **`events.rs`**: MIDIイベント（例: NoteOn, NoteOff, ProgramChange）の構造体と定義を含みます。
        - **`mod.rs`**: `midi` モジュールのエントリポイントで、サブモジュールの公開を管理します。
        - **`parser.rs`**: Standard MIDI Files (SMF) を読み込み、構造化された中間MIDIイベントに変換するロジックを提供します。
        - **`utils.rs`**: MIDIデータ処理に役立つ補助的な関数や定数を定義します。
    - **`src/ym2151/`**: YM2151 FM音源チップへの変換と関連データ処理に関するモジュール群です。
        - **`converter.rs`**: パースされたMIDIイベントを、YM2151のレジスタ書き込みログ形式に変換する主要なロジックを含みます。
        - **`events.rs`**: YM2151のレジスタ書き込みイベントの構造体と定義を含みます。
        - **`init.rs`**: YM2151チップの初期化やリセットに関連するレジスタ設定データやロジックを提供します。
        - **`mod.rs`**: `ym2151` モジュールのエントリポイントで、サブモジュールの公開を管理します。
        - **`note_table.rs`**: MIDIノート番号をYM2151が解釈できる周波数設定値（オペレータデータなど）に変換するためのテーブルやロジックを含みます。
        - **`tone.rs`**: YM2151の音色（FM合成パラメータ）の定義、ロード、および適用に関するロジックを提供し、プログラムチェンジイベントに対応します。
- **`tests/`**: プロジェクトのテストコードが格納されているディレクトリです。
    - **`create_test_midi.py`**: テストで使用する特定のMIDIファイルをプログラム的に生成するためのPythonスクリプトです。
    - **`integration_tests.rs`**: プロジェクトの複数のモジュールが連携して正しく動作するかを確認する統合テストが記述されています。
    - **`tests/test_data/`**: 各種テストシナリオで使用されるサンプルMIDIファイルが格納されています。
        - `multi_channel.mid`: 複数のMIDIチャンネルを使用するテストデータ。
        - `multi_track.mid`: 複数のトラックを使用するテストデータ。
        - `program_change.mid`: プログラムチェンジイベントを含むテストデータ。
        - `simple_melody.mid`: 単純なメロディを含むテストデータ。
        - `tempo_change.mid`: テンポチェンジイベントを含むテストデータ。
- **`tones/`**: カスタムYM2151音色定義をJSON形式で格納するディレクトリです。
    - **`000.json`**: プログラム0番（アコースティックグランドピアノなど）のデフォルト音色を定義するJSONファイルです。
    - **`README.md`**: `tones` ディレクトリの目的、カスタム音色ファイルの作成方法、フォーマットなどに関する説明ファイルです。

## 関数詳細説明
このプロジェクトはRustで実装されており、主要な機能は`src/lib.rs`、`src/main.rs`、`src/midi/parser.rs`、`src/ym2151/converter.rs`などのファイルで定義されています。提供された情報から具体的な関数シグネチャを完全に特定することはできませんが、プロジェクトの機能説明に基づき、主要な役割を持つ関数群とその機能を以下に示します。

- **`parse_midi_file`**
    - **役割**: 指定されたStandard MIDI Files (SMF) を読み込み、解析して、内部で使用する中間MIDIイベントのリストを生成します。
    - **引数**: MIDIファイルのパス (`&str`または`Path`)。
    - **戻り値**: パースされたMIDIイベントのリスト (`Vec<MidiEvent>`)、またはエラー情報 (`Result<(), Error>`)。
    - **機能**: MIDIファイルフォーマットを解釈し、ノートオン、ノートオフ、プログラムチェンジ、テンポ変更などのイベントを時系列データとして抽出します。

- **`convert_midi_events_to_ym2151_log`**
    - **役割**: パースされた中間MIDIイベントのリストを、YM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換します。
    - **引数**: 中間MIDIイベントのリスト (`Vec<MidiEvent>`)、カスタム音色ファイルが格納されたディレクトリのパス (`Option<&Path>`)。
    - **戻り値**: YM2151レジスタ書き込みイベントのリスト (`Vec<YM2151Event>`)、またはエラー情報 (`Result<(), Error>`)。
    - **機能**: MIDIイベント（特にノートオン/オフ）をYM2151のレジスタ操作にマッピングし、音色設定（プログラムチェンジ対応）、チャンネル割り当て戦略（和音数ベース、ドラム優先）、ノート周波数変換などを適用して詳細なレジスタログを構築します。

- **`save_json_file`**
    - **役割**: 指定されたデータ構造をJSON形式でファイルに書き出します。
    - **引数**: 保存先のファイルパス (`&str`または`Path`)、JSONにシリアライズするデータへの参照 (`&T`、`T`は`serde::Serialize`を実装)。
    - **戻り値**: 処理の成否 (`Result<(), Error>`)。
    - **機能**: パースの中間結果や最終的なYM2151ログをJSONファイルとして永続化します。

- **`load_ym2151_tone`**
    - **役割**: MIDIプログラム番号に基づいて、対応するYM2151のカスタム音色設定を外部JSONファイルからロードします。
    - **引数**: MIDIプログラム番号 (`u8`)、カスタム音色ファイルが格納されたディレクトリのパス (`&Path`)。
    - **戻り値**: ロードされたYM2151音色データ (`YM2151Tone`)、またはエラー情報 (`Result<(), Error>`)。
    - **機能**: `tones/` ディレクトリ内の`{program:03}.json`形式のファイルを検索し、存在すればその内容をYM2151音色として解析・提供します。ファイルが存在しない場合は、内蔵のデフォルト音色を返す可能性があります。

- **`main`**
    - **役割**: プログラムのエントリポイントとして、コマンドライン引数の解析、MIDIファイルの読み込み、変換処理の実行、結果のファイル保存といった一連のフローを調整します。
    - **引数**: なし (環境からコマンドライン引数を取得)。
    - **戻り値**: なし (プログラムの終了コードを返す)。
    - **機能**: `parse_midi_file` と `convert_midi_events_to_ym2151_log` を呼び出し、全体の変換プロセスをオーケストレートします。処理状況やエラーメッセージをコンソールに出力します。

## 関数呼び出し階層ツリー
```
（提供された情報では、具体的な関数呼び出し階層を分析することができませんでした。）

---
Generated at: 2025-11-26 07:07:50 JST
