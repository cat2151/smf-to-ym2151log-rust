Last updated: 2025-11-28

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をYM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換するRust実装です。
- 2パス処理アーキテクチャとRustの堅牢性を活かし、効率的かつ高精度な変換を実現します。
- カスタム音色対応やライブラリAPIも提供し、様々なオーディオプロジェクトでの利用をサポートします。

## 技術スタック
- フロントエンド: このプロジェクトはコマンドラインツールおよびライブラリであり、特定のフロントエンド技術は使用していません。
- 音楽・オーディオ:
    - **SMF (Standard MIDI Files)**: 入力として処理するMIDIデータの標準フォーマット。Format 0 および Format 1 をサポートします。
    - **MIDI (Musical Instrument Digital Interface)**: 音楽データを表現するためのデジタルインターフェース規格。特にGeneral MIDIドラムチャンネルの処理を含みます。
    - **YM2151**: ヤマハ製のFM音源チップ。プロジェクトの主要な出力先であり、そのレジスタ書き込みログ（JSON形式）を生成します。
    - **FM合成**: YM2151チップの原理である周波数変調合成。カスタム音色ファイルはこのパラメータを定義します。
- 開発ツール:
    - **Rust**: 高性能で安全なシステムプログラミング言語。プロジェクト全体がこの言語で実装されています。
    - **Cargo**: Rustの公式なビルドシステムおよびパッケージマネージャ。依存関係の管理、プロジェクトのビルド、テスト実行、ドキュメント生成などに使用されます。
    - **Git**: 分散型バージョン管理システム。ソースコードの変更履歴管理に利用されます。
- テスト:
    - **`cargo test`**: ユニットテストおよび統合テストを実行するためのRustの標準機能。
    - **`cargo tarpaulin`**: Rustプロジェクトのテストカバレッジを測定・レポートするためのツール。
- ビルドツール:
    - **Cargo**: Rustプロジェクトをコンパイルし、実行可能なバイナリやライブラリを生成するために使用されます。
- 言語機能:
    - **Rustの型システム**: コンパイル時の強力な型チェックにより、堅牢性と安全性の高いコードを実現します。
    - **ネイティブコンパイル**: 高い実行パフォーマンスを提供します。
- 自動化・CI/CD: 明示的なCI/CDツールは記載されていませんが、`cargo test`, `cargo fmt --check`, `cargo clippy`, `cargo audit` などのコマンドはCI/CDパイプラインに容易に組み込むことができます。
- 開発標準:
    - **`cargo fmt`**: Rustコードのフォーマットを自動的に適用し、コードの一貫性を保ちます。
    - **`cargo clippy`**: RustコードのLintチェックを実行し、潜在的なバグや非効率的なコードを検出します。
    - **`cargo audit`**: プロジェクトの依存関係における既知のセキュリティ脆弱性を監査します。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 21.md
  📖 22.md
  📖 23.md
  📖 25.md
  📖 28.md
  📖 30.md
  📖 32.md
  📖 33.md
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
    📄 tone.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 program_change.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
📁 tones/
  📊 000.json
  📖 README.md
```

## ファイル詳細説明
- `.gitignore`: Gitがバージョン管理の対象外とするファイルやディレクトリを指定する設定ファイルです。
- `Cargo.lock`: プロジェクトの依存関係の正確なバージョンを記録するファイルで、再現可能なビルドを保証します。
- `Cargo.toml`: Rustプロジェクトのメタデータ（プロジェクト名、バージョン、依存関係など）を定義するマニフェストファイルです。
- `LICENSE`: プロジェクトのライセンス情報（著作権、利用条件など）を記述したファイルです。
- `README.ja.md`: プロジェクトの概要、使い方、開発方法などを日本語で説明するメインのドキュメントファイルです。
- `README.md`: プロジェクトの概要、使い方、開発方法などを英語で説明するメインのドキュメントファイルです。
- `_config.yml`: GitHub Pagesなどの静的サイトジェネレーターの設定ファイル（プロジェクトのコンテキストから推測）です。
- `generated-docs/`: `cargo doc` などで生成されるAPIドキュメントやその他の生成物を格納するディレクトリです。
- `issue-notes/`: 開発中の課題や検討事項に関するメモを格納するディレクトリです。来訪者向けには詳細な内容は含まれません。
    - `21.md`, `22.md`, ..., `33.md`: 個別の課題に関するメモファイルです。
- `src/`: Rustのソースコードを格納するディレクトリです。
    - `error.rs`: アプリケーション固有のエラー型とエラーハンドリングロジックを定義するファイルです。
    - `lib.rs`: ライブラリクレートのエントリポイントで、他のRustプロジェクトから利用される公開APIを定義します。
    - `main.rs`: コマンドラインアプリケーションのエントリポイントで、`smf-to-ym2151log-rust` コマンドが実行されたときに呼び出されます。
    - `src/midi/`: MIDIファイル解析に関連するモジュールを格納するディレクトリです。
        - `events.rs`: MIDIイベントの内部表現（データ構造）を定義するファイルです。
        - `mod.rs`: `midi` モジュールのエントリポイントで、モジュール内の公開アイテムを宣言します。
        - `parser.rs`: Standard MIDI Files (SMF) のバイナリデータをパースし、内部のMIDIイベント表現に変換するロジックを実装したファイルです。
        - `utils.rs`: MIDIデータ処理に関連する補助的なユーティリティ関数や定数を定義するファイルです。
    - `src/ym2151/`: YM2151レジスタログ変換に関連するモジュールを格納するディレクトリです。
        - `converter.rs`: MIDIイベントをYM2151レジスタ書き込みログに変換する主要なロジックを実装したファイルです。チャンネル割り当て戦略なども含まれます。
        - `events.rs`: YM2151レジスタ書き込みイベントの内部表現を定義するファイルです。
        - `init.rs`: YM2151チップの初期化レジスタ設定に関するデータやロジックを定義するファイルです。
        - `mod.rs`: `ym2151` モジュールのエントリポイントで、モジュール内の公開アイテムを宣言します。
        - `note_table.rs`: MIDIノート番号とYM2151の周波数設定値（オペレーターパラメータ）の対応を定義するファイルです。
        - `tone.rs`: YM2151音色（トーン）のデータ構造と、外部JSONファイルからのロードロジックを定義するファイルです。
- `tests/`: 統合テストおよびテスト関連のスクリプトを格納するディレクトリです。
    - `create_test_midi.py`: テスト用のStandard MIDI Fileを生成するためのPythonスクリプトです。
    - `integration_tests.rs`: プロジェクト全体の機能をテストする統合テストを記述したファイルです。
    - `tests/test_data/`: 各種テストケースで使用されるサンプルMIDIファイルを格納するディレクトリです。
        - `multi_channel.mid`, `multi_track.mid`, `program_change.mid`, `simple_melody.mid`, `tempo_change.mid`: テスト用の特定のMIDIファイルです。
- `tones/`: カスタムYM2151音色定義JSONファイルを格納するディレクトリです。プログラムチェンジイベントに基づいてロードされます。
    - `000.json`: MIDIプログラム0番に対応するデフォルトのYM2151音色設定ファイルです。
    - `README.md`: `tones` ディレクトリの目的、音色ファイルのフォーマットなどを説明するドキュメントです。

## 関数詳細説明
- `main()`:
    - 役割: コマンドラインインターフェース(CLI)アプリケーションのエントリポイント。
    - 引数: なし (通常、環境やコマンドライン引数から内部的に処理)。
    - 戻り値: 成功またはエラーを示す結果。
    - 機能: コマンドライン引数を解析し、MIDIファイル変換の全体処理を起動します。エラーが発生した場合は適切なメッセージを表示します。

- `run_conversion(midi_path: &Path)`:
    - 役割: MIDIファイルの解析からYM2151レジスタログの生成まで、変換プロセス全体をオーケストレートする。
    - 引数: 変換対象のMIDIファイルへのパス (`midi_path`)。
    - 戻り値: 変換成功を示す結果、またはエラー。
    - 機能: パスA（MIDI解析）とパスB（YM2151変換）を順次実行し、中間イベントと最終YM2151ログをファイルに保存します。

- `midi::parser::parse_smf(data: &[u8])`:
    - 役割: Standard MIDI File (SMF) のバイナリデータを解析し、内部のMIDIイベントリストに変換する。
    - 引数: MIDIファイルのバイナリデータ (`data`)。
    - 戻り値: 解析されたMIDIイベントのリストとファイル情報、または解析エラー。
    - 機能: MIDIファイルのヘッダー、トラックチャンクを読み解き、ノートオン、ノートオフ、テンポチェンジ、プログラムチェンジなどのMIDIイベントを抽出します。

- `ym2151::converter::convert_to_ym2151_log(midi_events: Vec<MidiEvent>)`:
    - 役割: 解析されたMIDIイベントのリストを受け取り、YM2151 FM音源チップのレジスタ書き込みログに変換する。
    - 引数: パスAで生成されたMIDIイベントのリスト (`midi_events`)。
    - 戻り値: YM2151レジスタ書き込みイベントのリスト、または変換エラー。
    - 機能: MIDIイベントに基づいてYM2151チャンネルを割り当て、ノートオン/オフイベントをYM2151レジスタ操作に変換します。プログラムチェンジイベントに応じてカスタム音色をロードします。

- `ym2151::tone::load_tone(program_number: u8)`:
    - 役割: 指定されたプログラム番号に対応するYM2151音色定義を外部JSONファイルからロードする。
    - 引数: MIDIプログラムチェンジ番号 (`program_number`)。
    - 戻り値: ロードされたYM2151音色データ、またはロードエラー。
    - 機能: `tones/` ディレクトリ内の `{program_number:03}.json` ファイルを検索し、存在すればその内容をYM2151の音色データ構造にパースします。ファイルが存在しない場合は、内蔵のデフォルト音色を使用します。

- `ym2151::converter::assign_ym2151_channels(midi_events: &Vec<MidiEvent>)`:
    - 役割: MIDIチャンネルとYM2151のハードウェアチャンネル間の静的な割り当て戦略を決定する。
    - 引数: MIDIイベントの参照 (`midi_events`)。
    - 戻り値: 各MIDIチャンネルに割り当てられたYM2151チャンネルのマップ。
    - 機能: 各MIDIチャンネルの最大同時発音数（和音数）を分析し、ドラムチャンネル優先のルールに基づいてYM2151チャンネルを割り当てます。

- `ym2151::note_table::get_ym2151_note_params(midi_note: u8)`:
    - 役割: MIDIノート番号に対応するYM2151 FM音源の周波数設定パラメータを取得する。
    - 引数: 標準MIDIノート番号 (`midi_note`)。
    - 戻り値: YM2151のFRQ/BLKレジスタ設定値。
    - 機能: MIDIノート番号を、YM2151が音高を生成するために必要な内部的な周波数ブロックおよび周波数値に変換します。

## 関数呼び出し階層ツリー
```
main
├── run_conversion
│   ├── midi::parser::parse_smf
│   │   └── (内部的にmidi::events::MidiEventを生成)
│   ├── ym2151::converter::convert_to_ym2151_log
│   │   ├── ym2151::converter::assign_ym2151_channels
│   │   ├── ym2151::tone::load_tone (プログラムチェンジ発生時)
│   │   └── ym2151::note_table::get_ym2151_note_params
│   └── (出力JSONファイルの保存処理)

---
Generated at: 2025-11-28 07:07:34 JST
