Last updated: 2025-12-02

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をYM2151 FM音源チップ向けのレジスタ書き込みログ（JSON形式）に変換するRust製ツールおよびライブラリです。
- 2パス処理アーキテクチャとプログラムチェンジ対応により、高精度かつ柔軟なMIDIデータ処理を実現します。
- 型安全性と高パフォーマンスを特徴とし、他のRustプロジェクトへの組み込みやコマンドラインでの利用が可能です。

## 技術スタック
- フロントエンド: このプロジェクトはコマンドラインツールおよびライブラリであり、特定のフロントエンド技術は使用していません。
- 音楽・オーディオ:
    - Standard MIDI Files (SMF): 音楽データの標準フォーマットであり、本プロジェクトの入力形式です。
    - YM2151 FM音源チップ: Yamaha製のFM音源チップであり、本プロジェクトが出力するレジスタ書き込みログのターゲットです。
- 開発ツール:
    - Rust: プロジェクトの主要なプログラミング言語であり、堅牢性と高パフォーマンスを提供します。
    - Cargo: Rustの公式ビルドシステムおよびパッケージマネージャーで、依存関係管理、ビルド、テストなどを担当します。
    - Git: ソースコードのバージョン管理システムとして使用されています。
- テスト:
    - `cargo test`: Rust標準のテストフレームワークで、ユニットテストと統合テストの実行に使用されます。
    - `cargo tarpaulin`: Rustプロジェクトのコードカバレッジ測定ツールで、テスト網羅率のレポートを生成します。
- ビルドツール:
    - Cargo: プロジェクトのビルドプロセス全体を管理し、依存関係の解決と実行可能ファイルやライブラリの生成を行います。
- 言語機能:
    - Rustの型システム: コンパイル時の強力な型チェックにより、実行時エラーのリスクを低減し、コードの信頼性を向上させます。
- 自動化・CI/CD:
    - `cargo fmt`: Rustコードの自動フォーマットツールで、コードスタイルの一貫性を保ちます。
    - `cargo clippy`: Rustコードのリンターで、一般的な間違いや非効率なコードパターンを検出します。
    - `cargo audit`: Rustプロジェクトの依存関係における既知の脆弱性をチェックするツールです。
- 開発標準:
    - `cargo fmt`: コードの自動整形により、プロジェクト全体で統一されたコーディングスタイルを維持します。
    - `cargo clippy`: コードの品質を向上させ、保守性を高めるための静的解析を行います。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
🌐 googled947dc864c270e07.html
📁 issue-notes/
  📖 21.md
  📖 22.md
  📖 23.md
  📖 25.md
  📖 28.md
  📖 30.md
  📖 32.md
  📖 33.md
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
    📄 tone.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 program_change.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
📁 tones/
  📊 000.json
  📖 README.md
```

## ファイル詳細説明
-   **`.gitignore`**: Gitによるバージョン管理から除外するファイルやディレクトリを指定する設定ファイルです。
-   **`Cargo.lock`**: プロジェクトの依存関係ツリーと、それぞれの依存パッケージの正確なバージョンを記録するファイルです。これにより、開発環境間でのビルドの再現性を保証します。
-   **`Cargo.toml`**: Rustプロジェクトのビルド設定、メタデータ（プロジェクト名、バージョン、著者など）、および外部ライブラリへの依存関係を定義するマニフェストファイルです。
-   **`LICENSE`**: プロジェクトのソフトウェアライセンス情報（例: MIT License）を記載したファイルです。
-   **`README.ja.md`**: プロジェクトの概要、インストール方法、使い方、機能、開発に関する情報などを日本語で詳細に説明するドキュメントです。
-   **`README.md`**: `README.ja.md` と同様の内容を英語で提供するドキュメントです。
-   **`_config.yml`**: GitHub Pagesなどの静的サイトジェネレーター（Jekyllなど）で使用される設定ファイルで、サイトの表示やビルドに関するオプションを定義します。
-   **`generated-docs/`**: `cargo doc` コマンドによって生成されるAPIドキュメントが出力されるディレクトリです。
-   **`googled947dc864c270e07.html`**: Googleによるウェブサイトの所有権確認に使用されるファイルで、特定のGoogleサービス（Search Consoleなど）での認証目的で配置されます。
-   **`issue-notes/`**: 開発中の特定のIssueや課題に関するメモ、議論、調査結果などを個別のMarkdownファイルにまとめたディレクトリです。
    -   **`21.md` ~ `33.md`**: 各ファイルが特定のIssue番号に対応し、その詳細な内容や進捗を記録しています。
-   **`src/`**: プロジェクトの主要なRustソースコードが格納されているディレクトリです。
    -   **`error.rs`**: プロジェクト固有のカスタムエラー型とエラー処理ロジックを定義し、堅牢なエラーハンドリングを可能にします。
    -   **`lib.rs`**: プロジェクトがライブラリとして提供される場合のエントリポイントです。公開されるAPI、モジュール構造、主要な変換ロジックなどが含まれます。
    -   **`main.rs`**: コマンドラインアプリケーションとして実行される場合のエントリポイントです。コマンドライン引数の解析、ファイル入出力、全体の変換フローのオーケストレーションを担当します。
    -   **`midi/`**: Standard MIDI Files (SMF) のパースとイベント処理に関連するモジュールをまとめたディレクトリです。
        -   **`events.rs`**: MIDIイベント（NoteOn, NoteOff, ProgramChangeなど）のデータ構造とその処理ロジックを定義します。
        -   **`mod.rs`**: `midi` モジュール全体を定義し、その内部のサブモジュール（`events`, `parser`, `utils`）を公開します。
        -   **`parser.rs`**: SMF (Format 0およびFormat 1) を解析し、生のMIDIデータから内部表現のMIDIイベント構造体への変換ロジックを実装します。
        -   **`utils.rs`**: MIDIデータ処理に役立つ補助的な関数やヘルパーロジックを提供します。
    -   **`ym2151/`**: YM2151 FM音源チップに関連する変換ロジック、イベント定義、音色管理などをまとめたディレクトリです。
        -   **`converter.rs`**: 中間MIDIイベントをYM2151レジスタ書き込みログ（JSON形式）に変換する主要なロジック（パスB）を実装します。チャンネル割り当て戦略やボイス管理が含まれます。
        -   **`events.rs`**: YM2151チップのレジスタ書き込みイベントのデータ構造と、それらを表現するためのロジックを定義します。
        -   **`init.rs`**: YM2151チップの初期化時に必要なレジスタ設定やシーケンスを定義します。
        -   **`mod.rs`**: `ym2151` モジュール全体を定義し、その内部のサブモジュールを公開します。
        -   **`note_table.rs`**: MIDIノート番号からYM2151が解釈する周波数やキーオン/オフに関連する内部値へのマッピングテーブルや変換ロジックを提供します。
        -   **`tone.rs`**: YM2151の音色（オペレーターパラメータなど）のデータ構造、外部JSONファイルからのロード、およびプログラムチェンジイベントに応じた音色の適用ロジックを定義します。
-   **`tests/`**: プロジェクトの統合テストやテスト用データを生成するスクリプトが格納されているディレクトリです。
    -   **`create_test_midi.py`**: 異なるシナリオ（複数チャンネル、プログラムチェンジなど）のテスト用MIDIファイルをプログラム的に生成するためのPythonスクリプトです。
    -   **`integration_tests.rs`**: 主要な機能やモジュール間の連携を確認するための統合テストケースを定義するファイルです。
    -   **`test_data/`**: 統合テストで使用されるサンプルMIDIファイルを格納するディレクトリです。
        -   **`multi_channel.mid`**: 複数のMIDIチャンネルを含むテスト用のMIDIファイルです。
        -   **`multi_track.mid`**: 複数のトラックを含むテスト用のMIDIファイルです。
        -   **`program_change.mid`**: MIDIプログラムチェンジイベントを含むテスト用のMIDIファイルです。
        -   **`simple_melody.mid`**: 簡単なメロディを含むテスト用のMIDIファイルです。
        -   **`tempo_change.mid`**: テンポ変更イベントを含むテスト用のMIDIファイルです。
-   **`tones/`**: MIDIプログラムチェンジイベントに対応するカスタムYM2151音色定義JSONファイルを格納するディレクトリです。
    -   **`000.json`**: MIDIプログラム番号000（通常グランドピアノ）に割り当てられるYM2151音色を定義するJSONファイルです。
    -   **`README.md`**: `tones` ディレクトリ内のJSONファイルのフォーマット、構造、およびカスタム音色の作成方法について説明するドキュメントです。

## 関数詳細説明
このプロジェクトはRustで記述されており、その特性上、多数のモジュール化された関数が存在します。主な関数の概念的な役割は以下の通りです。

-   **`fn main()`** (in `src/main.rs`):
    -   **役割**: コマンドラインインターフェースのエントリポイント。
    -   **機能**: コマンドライン引数を解析し、入力MIDIファイルのパスを取得します。MIDIファイルの読み込み、パース（パスA）、YM2151レジスタログへの変換（パスB）、そして結果のJSONファイルを指定されたパスに保存するという一連のワークフローを制御します。エラーが発生した場合は適切なメッセージを出力します。
-   **変換処理の主要関数** (in `src/lib.rs`):
    -   **役割**: ライブラリとしてプロジェクトのコアなMIDI-YM2151変換機能を提供します。
    -   **機能**: MIDIデータ（バイト配列など）と設定を受け取り、YM2151のレジスタログデータ構造を生成して返します。この関数が、内部的にMIDIパーサーとYM2151コンバーターを呼び出し、2パス処理を統合します。
-   **MIDIパース関数** (e.g., in `src/midi/parser.rs`):
    -   **役割**: Standard MIDI Filesを解析し、内部的なMIDIイベント構造体へと変換します。
    -   **機能**: MIDIファイルフォーマット（Format 0/1）のヘッダ、トラックチャンク、イベントデータを読み込み、タイムスタンプ付きの構造化されたイベントリストを生成します。
-   **YM2151変換関数** (e.g., in `src/ym2151/converter.rs`):
    -   **役割**: 内部的なMIDIイベントを、YM2151チップのレジスタ書き込みを模倣したイベントログに変換します。
    -   **機能**: MIDIノートイベント、プログラムチェンジ、テンポ変更などをYM2151固有のレジスタアドレスとデータにマッピングします。和音数分析に基づいた静的チャンネル割り当て、ボイス管理、ドラムチャンネル優先などのロジックが適用されます。
-   **音色関連関数** (e.g., in `src/ym2151/tone.rs`):
    -   **役割**: YM2151の音色データをロードし、変換プロセスに適用します。
    -   **機能**: 指定されたプログラム番号に基づいて、`tones/` ディレクトリから対応するJSON音色ファイルを読み込みます。ファイルが見つからない場合はデフォルト音色を使用します。ロードされた音色データは、YM2151レジスタ書き込みイベントとして変換ログに挿入されます。

これらの関数は、それぞれ引数として必要なデータ（例: MIDIバイト列、設定オブジェクト）を受け取り、処理結果（例: パースされたイベントリスト、YM2151ログ）を返します。エラーが発生した場合は、`src/error.rs` で定義されたカスタムエラー型を返す可能性があります。

## 関数呼び出し階層ツリー
```
関数呼び出し階層を分析できませんでした。

---
Generated at: 2025-12-02 07:07:34 JST
