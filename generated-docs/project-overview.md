Last updated: 2025-12-03

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をYM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換するRust製のコマンドラインツールおよびライブラリです。
- 2パス処理アーキテクチャを採用し、MIDIファイルのパースとYM2151ログへの変換を分離、プログラムチェンジによるカスタム音色読み込みにも対応しています。
- 型安全性と高パフォーマンスを特徴とし、`cat-play-mml`などの他のRustプロジェクトからライブラリとして利用可能です。

## 技術スタック
- フロントエンド: 該当なし（コマンドラインインターフェース（CLI）アプリケーションであり、ウェブやGUIのフロントエンドは持ちません）
- 音楽・オーディオ: Standard MIDI Files (SMF) フォーマットの解析、YM2151 FM音源チップのレジスタ操作ロジック、JSON形式によるYM2151レジスタ書き込みログ出力
- 開発ツール: Git (バージョン管理), Cargo (Rustパッケージマネージャー、ビルドツール)
- テスト: `cargo test` (ユニットテスト、統合テストの実行), `cargo tarpaulin` (テストカバレッジレポート生成)
- ビルドツール: Cargo (Rustプロジェクトのビルドおよびパッケージ管理)
- 言語機能: Rust (高パフォーマンス、型安全性、メモリ安全性を特徴とするシステムプログラミング言語)
- 自動化・CI/CD: なし（ただし、開発標準のチェックはCI/CDに組み込むことが可能）
- 開発標準: Rustfmt (コードフォーマットの自動適用・チェック), Clippy (Lintツールによるコード品質・慣用句チェック), Cargo audit (依存関係のセキュリティ脆弱性チェック)

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
🌐 googled947dc864c270e07.html
📁 issue-notes/
  📖 21.md
  📖 22.md
  📖 23.md
  📖 25.md
  📖 28.md
  📖 30.md
  📖 32.md
  📖 33.md
  📖 34.md
  📖 36.md
  📖 38.md
  📖 39.md
  📖 41.md
  📖 43.md
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 channel_allocation.rs
    📄 converter.rs
    📄 converter_tests.rs
    📄 event_processor.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
    📄 tempo_map.rs
    📄 tone.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 program_change.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
📁 tones/
  📊 000.json
  📖 README.md
```

## ファイル詳細説明
-   **`.gitignore`**: Gitによるバージョン管理の対象外とするファイルやディレクトリを指定します。
-   **`Cargo.lock`**: Rustプロジェクトの依存関係ツリーの正確なバージョンとチェックサムを記録し、再現可能なビルドを保証します。
-   **`Cargo.toml`**: Rustプロジェクトのマニフェストファイル。プロジェクト名、バージョン、ライブラリの依存関係、ビルド設定などを定義します。
-   **`LICENSE`**: このプロジェクトのソフトウェアライセンス情報が記載されています。
-   **`README.ja.md`**: プロジェクトの日本語での概要、機能、使い方、開発情報などを説明するドキュメントです。
-   **`README.md`**: プロジェクトの英語での概要、機能、使い方、開発情報などを説明するドキュメントです。
-   **`_config.yml`**: GitHub Pagesなどのウェブサイト生成ツールの設定ファイルです。
-   **`generated-docs/`**: `cargo doc` コマンドによって生成されるRustのAPIドキュメントが格納されます。
-   **`googled947dc864c270e07.html`**: Googleのサイト所有権確認のために配置されたファイルです。
-   **`issue-notes/`**: 開発中に発生した課題、検討事項、調査結果などを個別のMarkdownファイルとして記録するディレクトリです。
    -   `21.md` - `43.md`: 個々の課題や検討事項を詳細に記述したメモファイルです。
-   **`src/`**: プロジェクトの主要なソースコードが格納されているディレクトリです。
    -   **`error.rs`**: プロジェクト全体で利用されるカスタムエラー型を定義し、エラーハンドリングを一元化します。
    -   **`lib.rs`**: このプロジェクトがライブラリとして提供する機能のエントリーポイントです。他のRustプロジェクトから利用されるAPIを公開します。
    -   **`main.rs`**: コマンドラインツールとしてこのプログラムを実行する際のエントリーポイントです。コマンドライン引数のパースと、変換処理のオーケストレーションを行います。
    -   **`src/midi/`**: MIDIファイルのパースと、関連するイベント処理を行うためのモジュール群です。
        -   **`events.rs`**: Standard MIDI File内の様々なMIDIイベント（Note On/Off、プログラムチェンジなど）を表すデータ構造を定義します。
        -   **`mod.rs`**: `midi` モジュールの宣言と、そのサブモジュールの公開を管理します。
        -   **`parser.rs`**: Standard MIDI Files (SMF) のバイナリデータを読み込み、内部のMIDIイベント構造に変換するパースロジックを実装します。
        -   **`utils.rs`**: MIDI関連のヘルパー関数やユーティリティロジックを提供します。
    -   **`src/ym2151/`**: YM2151 FM音源チップのレジスタ書き込みログへの変換に関連するモジュール群です。
        -   **`channel_allocation.rs`**: MIDIチャンネルの同時発音数に基づいて、YM2151の物理チャンネルを効率的に割り当てる戦略（和音数ベース、ドラム優先など）を実装します。
        -   **`converter.rs`**: MIDIイベントデータをYM2151レジスタ書き込みログ形式のJSONデータに変換する中心的なロジックを実装します。
        -   **`converter_tests.rs`**: `converter.rs` で実装された変換ロジックのユニットテストを定義します。
        -   **`event_processor.rs`**: 各MIDIイベントを受け取り、対応するYM2151レジスタ書き込みイベントを生成する処理ロジックを実装します。
        -   **`events.rs`**: YM2151のレジスタ書き込みイベントを表すデータ構造や、出力されるJSONのスキーマを定義します。
        -   **`init.rs`**: YM2151チップを正しく動作させるための初期レジスタ設定やリセット処理に関する定数を定義します。
        -   **`mod.rs`**: `ym2151` モジュールの宣言と、そのサブモジュールの公開を管理します。
        -   **`note_table.rs`**: MIDIノート番号とYM2151が要求する周波数パラメータ（DT/MUL、FB、TLなど）のマッピングテーブルを提供します。
        -   **`tempo_map.rs`**: MIDIファイル内のテンポ変更イベントを管理し、イベントの時間位置をティックから秒（またはYM2151のクロックサイクル）に変換するための時間軸マッピングを提供します。
        -   **`tone.rs`**: プログラムチェンジイベントに対応するYM2151の音色定義（オペレーターパラメータなど）を管理し、外部JSONファイルからのロード機能を提供します。
-   **`tests/`**: プロジェクトのテストコードや、テストに使用される補助ファイルが格納されています。
    -   **`create_test_midi.py`**: 統合テストで使用するための様々な種類のMIDIファイルをプログラム的に生成するPythonスクリプトです。
    -   **`integration_tests.rs`**: プロジェクト全体としての機能が期待通りに動作するかを確認するための統合テストを定義します。
    -   **`tests/test_data/`**: 統合テストで入力として使用されるサンプルMIDIファイルが格納されています。
        -   `multi_channel.mid`: 複数のMIDIチャンネルを使用するテストケース用のMIDIファイル。
        -   `multi_track.mid`: 複数のトラックを持つMIDIファイルで、トラック処理のテストに使用。
        -   `program_change.mid`: プログラムチェンジイベントを含むMIDIファイルで、音色切り替え機能のテストに使用。
        -   `simple_melody.mid`: 単純なメロディを含むMIDIファイルで、基本的なノート変換のテストに使用。
        -   `tempo_change.mid`: テンポ変更イベントを含むMIDIファイルで、テンポマッピング機能のテストに使用。
-   **`tones/`**: カスタムYM2151音色定義をJSON形式で格納するディレクトリです。プログラムチェンジイベントでこれらのファイルを読み込みます。
    -   **`000.json`**: MIDIプログラム0番（アコースティックグランドピアノ相当）に対応するYM2151のデフォルト音色設定を定義したJSONファイルです。
    -   **`README.md`**: `tones` ディレクトリ内のカスタム音色ファイルの作成方法やJSONフォーマットに関する詳細を説明するドキュメントです。

## 関数詳細説明
提供された情報からは個別の関数の詳細なシグネチャ（引数、戻り値）を直接抽出することはできませんでしたが、プロジェクトの機能説明に基づき、主要な役割を持つと思われる関数とその機能について説明します。

-   **`main()`** (in `src/main.rs`)
    -   **役割**: コマンドラインアプリケーションのエントリーポイント。
    -   **機能**: コマンドライン引数をパースし、指定されたMIDIファイルを読み込み、変換処理の全体をオーケストレート（調整・実行）します。中間イベントと最終YM2151ログの生成およびファイル保存を制御します。
-   **`parse_midi_file(path: &Path)`** (likely in `src/midi/parser.rs`)
    -   **役割**: Standard MIDI Files (SMF) を解析し、内部の構造化されたMIDIイベントリストに変換します。
    -   **機能**: 指定されたパスのMIDIファイルをバイナリ形式で読み込み、MIDIフォーマット0または1のデータ構造を解析して、時間情報やイベントタイプ（Note On/Off, プログラムチェンジなど）を含む中間イベントデータ（パスA出力）を生成します。
-   **`convert_to_ym2151_log(midi_events: Vec<MidiEvent>)`** (likely in `src/ym2151/converter.rs`)
    -   **役割**: 中間MIDIイベントデータを受け取り、YM2151レジスタ書き込みログ形式のJSONデータに変換します。
    -   **機能**: 入力されたMIDIイベントリストをYM2151の制約（8チャンネル、ボイス管理、テンポ、プログラムチェンジ）を考慮して処理し、YM2151レジスタアドレスとデータ、タイミング情報を含むイベントのシーケンス（パスB出力）を生成します。
-   **`allocate_channels(midi_channel_counts: &[u8])`** (likely in `src/ym2151/channel_allocation.rs`)
    -   **役割**: MIDIチャンネルの同時発音数に基づいて、YM2151の8つの物理チャンネルを効率的に割り当てます。
    -   **機能**: 各MIDIチャンネルの最大和音数を分析し、複数のYM2151チャンネルを必要に応じて割り当てます。特に、General MIDIのドラムチャンネル（MIDIチャンネル9）をYM2151チャンネル0に優先的に割り当てるロジックを含みます。
-   **`process_midi_event(event: &MidiEvent, context: &mut Ym2151Context)`** (likely in `src/ym2151/event_processor.rs`)
    -   **役割**: 個々のMIDIイベントを処理し、YM2151のレジスタ書き込みイベントに変換します。
    -   **機能**: ノートオン/オフ、プログラムチェンジ、テンポ変更などのMIDIイベントをYM2151のレジスタ操作にマッピングします。ノートの周波数計算、オペレーターパラメータの設定、ボイス管理などを担当します。
-   **`load_tone_definition(program_number: u8)`** (likely in `src/ym2151/tone.rs`)
    -   **役割**: 指定されたプログラム番号に対応するYM2151の音色定義をロードします。
    -   **機能**: `tones/` ディレクトリから`{program:03}.json`形式の音色設定ファイルを検索・読み込みます。ファイルが見つからない場合は、組み込みのデフォルト音色設定を使用します。

## 関数呼び出し階層ツリー
```
提供された情報からは、関数呼び出し階層ツリーを分析できませんでした。

---
Generated at: 2025-12-03 07:07:36 JST
