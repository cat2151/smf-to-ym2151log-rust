Last updated: 2025-11-22

# Project Overview

## プロジェクト概要
- Standard MIDI Files (SMF) をYM2151 FM音源チップのレジスタ書き込みログ（JSON形式）に変換するRustアプリケーションです。
- 変換処理は2パスアーキテクチャを採用し、YM2151のカスタム音色定義にも対応しています。
- 型安全性と高いパフォーマンスを特徴とし、他のRustプロジェクトからライブラリとしても利用可能です。

## 技術スタック
### 音楽・オーディオ
- **Standard MIDI Files (SMF)**: デジタル楽器やソフトウェア間で音楽データを交換するための国際標準フォーマット。このプロジェクトの入力データ形式です。
- **YM2151 FM音源チップ**: Yamahaが開発したFM音源チップで、このプロジェクトが出力するレジスタ書き込みログのターゲットとなるハードウェアです。
### 開発ツール
- **Rust**: 高速でメモリ効率が高く、堅牢なソフトウェア開発を可能にするシステムプログラミング言語。このプロジェクトの基盤言語として採用されています。
- **Cargo**: Rustの公式パッケージマネージャーおよびビルドシステム。プロジェクトの依存関係管理、ビルド、テスト、ドキュメント生成など、開発サイクル全体をサポートします。
- **Git**: 分散型バージョン管理システム。ソースコードの変更履歴の追跡と管理に使用されます。
### テスト
- **Rustのテストフレームワーク**: Rustに標準搭載されているテスト機能。ユニットテストと統合テストの実装に利用され、コードの品質と信頼性を保証します。
- **cargo tarpaulin**: Rustプロジェクトのコードカバレッジを測定するためのツール。テストがコードのどの範囲をカバーしているかを確認できます。
### ビルドツール
- **Cargo**: (開発ツールと重複しますが、ビルド実行の主要な役割を担うため再度記載) Rustプロジェクトのコンパイルと実行可能ファイルの生成を管理します。
### 言語機能
- **Rustの型システム**: コンパイル時に厳密な型チェックを行うことで、ランタイムエラーの発生を抑制し、コードの堅牢性と安全性を高めます。
### 開発標準
- **cargo fmt**: Rustコードの自動フォーマッター。プロジェクト全体で一貫したコーディングスタイルを維持し、コードの可読性を向上させます。
- **cargo clippy**: RustコードのLintツール。一般的なミスや非効率なコードパターンを検出し、コード品質と保守性を向上させるための提案を行います。
- **cargo audit**: プロジェクトの依存関係における既知のセキュリティ脆弱性をチェックするツール。サプライチェーン攻撃のリスクを低減します。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📖 IMPLEMENTATION.md
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 21.md
  📖 22.md
  📖 23.md
  📖 25.md
  📖 28.md
  📖 30.md
📁 src/
  📄 error.rs
  📄 lib.rs
  📄 main.rs
  📁 midi/
    📄 events.rs
    📄 mod.rs
    📄 parser.rs
    📄 utils.rs
  📁 ym2151/
    📄 converter.rs
    📄 events.rs
    📄 init.rs
    📄 mod.rs
    📄 note_table.rs
    📄 tone.rs
📁 tests/
  📄 create_test_midi.py
  📄 integration_tests.rs
  📁 test_data/
    📄 multi_channel.mid
    📄 multi_track.mid
    📄 program_change.mid
    📄 simple_melody.mid
    📄 tempo_change.mid
📁 tones/
  📊 000.json
  📖 README.md
```

## ファイル詳細説明
- **`.gitignore`**: Gitのバージョン管理から除外するファイルやディレクトリを指定します。
- **`Cargo.lock`**: `Cargo.toml`に基づいて実際に使用された依存ライブラリの厳密なバージョンを記録します。
- **`Cargo.toml`**: Rustプロジェクトの設定ファイル。プロジェクト名、バージョン、依存関係、ビルドオプションなどが定義されています。
- **`IMPLEMENTATION.md`**: プロジェクトの技術的な実装の詳細や設計に関するドキュメントです。
- **`LICENSE`**: プロジェクトの配布および使用に関するライセンス情報が記載されています。
- **`README.ja.md`**: プロジェクトの日本語版概要説明ドキュメントです。
- **`README.md`**: プロジェクトの英語版概要説明ドキュメントです。
- **`_config.yml`**: GitHub Pagesなどの静的サイトジェネレーターの設定ファイルです。
- **`generated-docs/`**: `cargo doc`コマンドによって生成されるAPIドキュメントが格納されるディレクトリです。
- **`issue-notes/`**: 開発中に発生した特定の課題や検討事項に関するメモが格納されるディレクトリです。各`.md`ファイルは個別の課題に対応します。
- **`src/`**: プロジェクトの主要なRustソースコードが格納されているディレクトリです。
    - **`src/error.rs`**: プロジェクト全体で使用されるカスタムエラー型を定義し、エラーハンドリングを一元化します。
    - **`src/lib.rs`**: ライブラリクレートのエントリポイント。他のRustプロジェクトから再利用可能な公開APIを提供します。
    - **`src/main.rs`**: コマンドラインツールとしてのエントリポイント。CLI引数の解析、変換処理の呼び出し、ファイル入出力など、アプリケーションの主要な実行ロジックを含みます。
    - **`src/midi/`**: MIDIファイルの解析と処理に関連するモジュール群です。
        - **`src/midi/events.rs`**: MIDIイベント（例: Note On, Note Off, Tempo Change）のデータ構造を定義します。
        - **`src/midi/mod.rs`**: `src/midi`ディレクトリ内のモジュールを公開し、MIDI関連機能のルートモジュールとして機能します。
        - **`src/midi/parser.rs`**: Standard MIDI File (SMF) のバイナリデータを解析し、内部的なMIDIイベントのシーケンスに変換するロジックを実装します。
        - **`src/midi/utils.rs`**: MIDI関連のヘルパー関数やユーティリティ機能を提供します。
    - **`src/ym2151/`**: YM2151レジスタ書き込みログへの変換に関連するモジュール群です。
        - **`src/ym2151/converter.rs`**: MIDIイベントをYM2151レジスタ書き込みログのJSON形式に変換する主要なロジックを実装します。和音数に基づくチャンネル割り当てやボイス管理の戦略もここで処理されます。
        - **`src/ym2151/events.rs`**: YM2151レジスタへの書き込みイベントのデータ構造を定義します。
        - **`src/ym2151/init.rs`**: YM2151チップの初期化に必要なレジスタ設定を定義します。
        - **`src/ym2151/mod.rs`**: `src/ym2151`ディレクトリ内のモジュールを公開し、YM2151関連機能のルートモジュールとして機能します。
        - **`src/ym2151/note_table.rs`**: MIDIノート番号とYM2151の周波数設定（FB, KC, KFレジスタ値）間のマッピングを提供するテーブルを定義します。
        - **`src/ym2151/tone.rs`**: YM2151の音色データ構造を定義し、外部JSONファイルからカスタム音色をロードする機能を提供します。
- **`tests/`**: プロジェクトのテストコードが格納されているディレクトリです。
    - **`tests/create_test_midi.py`**: 統合テストで使用するMIDIファイルをプログラム的に生成するためのPythonスクリプトです。
    - **`tests/integration_tests.rs`**: アプリケーション全体の連携をテストする統合テストコードが記述されています。
    - **`tests/test_data/`**: 各種テストで使用されるMIDIファイルなどのデータが格納されています。
        - **`tests/test_data/multi_channel.mid`**: 複数のMIDIチャンネルを使用するテスト用MIDIファイル。
        - **`tests/test_data/multi_track.mid`**: 複数のMIDIトラックを使用するテスト用MIDIファイル。
        - **`tests/test_data/program_change.mid`**: プログラムチェンジイベントを含むテスト用MIDIファイル。
        - **`tests/test_data/simple_melody.mid`**: 単純なメロディを含むテスト用MIDIファイル。
        - **`tests/test_data/tempo_change.mid`**: テンポチェンジイベントを含むテスト用MIDIファイル。
- **`tones/`**: カスタムYM2151音色を定義するJSONファイルが格納されるディレクトリです。
    - **`tones/000.json`**: プログラム0番（アコースティックグランドピアノ）のデフォルト音色定義です。
    - **`tones/README.md`**: カスタム音色ファイルの作成方法やフォーマットに関する説明ドキュメントです。

## 関数詳細説明
提供されたプロジェクト情報には、個々の関数の具体的な名前、引数、戻り値に関する詳細な記述がありません。そのため、ここでは各モジュールが担う主要な機能の概要を、対応する関数群として説明します。

- **`src/main.rs`**: コマンドラインインターフェース（CLI）のエントリポイントとして、以下のような関数群が存在します。
    - コマンドライン引数を解析し、入力MIDIファイルのパスやオプションを取得する機能。
    - MIDIファイルを読み込み、中間イベントへの変換処理を呼び出す機能。
    - 中間イベントをYM2151ログに変換する処理を呼び出す機能。
    - 生成された中間イベントJSONファイルおよびYM2151ログJSONファイルを指定されたパスに保存する機能。
    - 変換処理の進捗状況や結果をコンソールに出力する機能。
- **`src/lib.rs`**: ライブラリとして外部から利用されることを想定し、以下のような公開関数群が存在すると考えられます。
    - 指定されたMIDIファイルのパスからYM2151レジスタ書き込みログへの変換をエンドツーエンドで実行する高レベルな関数。
    - MIDIファイルを解析して中間イベントを返す関数。
    - 中間イベントからYM2151ログを生成する関数。
    - これらの関数は、エラーハンドリングを含む堅牢なインターフェースを提供するでしょう。
- **`src/midi/parser.rs`**: MIDIファイルの解析を担当する関数群です。
    - Standard MIDI Fileのバイナリデータを読み込み、構造化された内部イベント表現にパースする関数。
    - トラックデータ、テンポイベント、タイムシグネチャなどのMIDIイベントを識別し、抽出する機能。
    - MIDIフォーマット0および1のファイル構造に対応し、イベントのタイムスタンプを正確に計算する機能。
- **`src/ym2151/converter.rs`**: MIDIイベントをYM2151レジスタ書き込みログに変換する中核的な関数群です。
    - MIDIチャンネルの和音数を分析し、YM2151の8チャンネルに割り当てるためのロジックを実装した関数。
    - MIDIノートオン/オフイベントをYM2151のFM音源レジスタへの書き込みシーケンスに変換する関数。
    - プログラムチェンジイベントに応じて、カスタム音色ファイルからYM2151のオペレータパラメータを読み込み、適用する機能。
    - 同一MIDIチャンネルに複数のYM2151チャンネルが割り当てられている場合、ノートをラウンドロビン方式で分配し、ボイスを管理する機能。
    - ドラムチャンネル（MIDIチャンネル9）をYM2151チャンネル0に優先的に割り当てる機能。
- **`src/ym2151/tone.rs`**: YM2151の音色に関する関数群です。
    - JSON形式で定義されたカスタム音色ファイルを読み込み、YM2151レジスタパラメータのデータ構造に変換する関数。
    - デフォルトのYM2151音色（例: プログラム000）を提供する機能。
- **`src/error.rs`**: エラー処理のための関数群です。
    - プロジェクト固有のエラー条件（例: ファイルが見つからない、MIDIパースエラー、YM2151変換エラー）を表現するカスタムエラー型を生成する関数。
    - 異なるエラーをラップし、統一された方法でエラーを伝播させる機能。

## 関数呼び出し階層ツリー
```
関数呼び出し階層を分析できませんでした

---
Generated at: 2025-11-22 07:07:37 JST
