# MML Input Support via mmlabc-to-smf-rust Integration

This document explains how to use MML (Music Macro Language) input in the demo by integrating with the [mmlabc-to-smf-rust](https://github.com/cat2151/mmlabc-to-smf-rust) library.

## Project Structure

The demo is built with **Vite** and **TypeScript** for better maintainability:

```
├── index.html              # Clean HTML structure (no inline JS/CSS)
├── src/
│   ├── main.ts            # TypeScript application logic
│   └── style.css          # All CSS styles  
├── package.json           # Node.js dependencies (Vite, TypeScript)
├── tsconfig.json          # TypeScript configuration
├── vite.config.ts         # Vite build configuration
├── dist/                  # Build output (generated by `npm run build`)
└── index-mml-monolith.html # Old monolithic version (backup)
```

## Architecture

The integration uses a two-WASM-module architecture:

```
MML Text Input
     ↓
JavaScript + web-tree-sitter
     ↓
Parse Tree JSON
     ↓
mmlabc-to-smf-wasm (External)
     ↓
SMF Binary
     ↓
smf-to-ym2151log WASM (This Project)
     ↓
YM2151 Register Log JSON
```

## Why This Approach?

The mmlabc-to-smf-rust library uses tree-sitter for MML parsing, which requires C compilation. However, it provides a WASM-compatible path using:
- **web-tree-sitter**: Browser-compatible parser (no C compilation needed)
- **mmlabc-to-smf-wasm**: Separate WASM crate that receives parse trees from web-tree-sitter

This allows full MML support in the browser without any C compilation requirements.

## Setup Instructions

### 1. Install Node.js Dependencies

```bash
npm install
```

This installs Vite and TypeScript for development.

### 2. Build This Project's WASM Module

```bash
wasm-pack build --target web --features wasm
```

### 3. (Optional) Setup mmlabc-to-smf-wasm for MML Support

To enable MML input functionality:

To enable MML input functionality:

#### a. Clone mmlabc-to-smf-rust Repository

```bash
git clone https://github.com/cat2151/mmlabc-to-smf-rust
cd mmlabc-to-smf-rust
```

#### b. Install Dependencies

```bash
cd demo
npm install  # Installs web-tree-sitter
```

#### c. Build WASM Modules

```bash
# Build mmlabc-to-smf WASM module
cd ../mmlabc-to-smf-wasm
wasm-pack build --target web

# Build tree-sitter grammar for WASM
cd ../tree-sitter-mml
npm install  # If tree-sitter-cli not already installed
npx tree-sitter build-wasm
```

#### d. Copy Required Files

Copy the following files to your smf-to-ym2151log-rust demo directory:

```bash
# From mmlabc-to-smf-rust repository root:
cd /path/to/mmlabc-to-smf-rust

# Copy mmlabc WASM module
cp -r mmlabc-to-smf-wasm/pkg /path/to/smf-to-ym2151log-rust/mmlabc-pkg

# Copy tree-sitter grammar WASM
cp tree-sitter-mml/tree-sitter-mml.wasm /path/to/smf-to-ym2151log-rust/

# Copy web-tree-sitter runtime
cp demo/node_modules/web-tree-sitter/web-tree-sitter.js /path/to/smf-to-ym2151log-rust/public/
cp demo/node_modules/web-tree-sitter/web-tree-sitter.wasm /path/to/smf-to-ym2151log-rust/public/
```

### 4. Run Development Server

```bash
npm run dev
```

The demo will be available at http://localhost:8000

### 5. Build for Production

```bash
npm run build
```

Built files will be in the `dist/` directory. Serve them with any static file server:

```bash
npm run preview  # Preview production build
# or
python3 -m http.server 8000 --directory dist
```

## Development Workflow

### File Structure

- **HTML** (`index.html`): Clean semantic markup, no inline styles or scripts
- **CSS** (`src/style.css`): All styles including dark mode
- **TypeScript** (`src/main.ts`): Type-safe application logic

### Making Changes

1. Edit files in `src/`
2. Vite automatically reloads the page (during `npm run dev`)
3. TypeScript catches type errors at development time
4. Build for production with `npm run build`

### Benefits of This Structure

- **Separation of Concerns**: HTML, CSS, and logic are in separate files
- **Type Safety**: TypeScript catches errors before runtime
- **Fast Development**: Vite provides instant hot module replacement
- **Modern Tooling**: ES modules, tree-shaking, minification
- **Maintainability**: Easier to modify and debug

## Original Monolithic Version

The original version with inline CSS and JavaScript is preserved as `index-mml-monolith.html` for reference.

## Using the Demo

### MIDI File Tab
- Click "MIDI File" tab
- Select a .mid file
- View the YM2151 register log output

### MML Input Tab (requires mmlabc-to-smf-wasm setup)
- Click "MML Input" tab
- Enter MML code or click an example button
- Click "Convert to YM2151"
- View the YM2151 register log output

## MML Syntax Examples

- `cdefgab` - Simple melody
- `o5 l4 cdefgab` - With octave and length settings
- `c;e;g` - C major chord (multi-channel)
- `o4 c c g g a a g2 f f e e d d c2` - Twinkle Twinkle Little Star

For full MML syntax, see the [mmlabc-to-smf-rust grammar](https://github.com/cat2151/mmlabc-to-smf-rust/blob/main/tree-sitter-mml/grammar.js).

## Implementation Notes

### Why Not a Single Dependency?

The mmlabc-to-smf library is split into:
1. **Core library**: Converts tokens/AST/events to SMF (pure Rust, WASM-compatible)
2. **CLI with tree-sitter**: Native parser for command-line use
3. **WASM crate**: Browser interface using web-tree-sitter

We cannot directly depend on mmlabc-to-smf in our Cargo.toml for WASM because:
- The tree-sitter parsing happens in JavaScript (web-tree-sitter)
- The WASM modules communicate via JavaScript glue code
- Each WASM module is compiled separately and loaded independently

## Troubleshooting

### "MML WASM module not available"
- Ensure you've copied all required files from mmlabc-to-smf-rust
- Check browser console for detailed error messages

### "Failed to initialize WASM"
- Ensure you've run `wasm-pack build --target web --features wasm`
- Check that pkg/ directory exists with the WASM files
- Verify you're serving files via HTTP server (not file://)

### Build Errors
- Run `npm install` to ensure all dependencies are installed
- Check that TypeScript and Vite versions are compatible
- Clear `node_modules` and reinstall if needed

### CORS Errors
- Use `npm run dev` or another local HTTP server
- Don't open HTML files directly (file:// protocol)

## Reference

- [Vite Documentation](https://vitejs.dev/)
- [TypeScript Documentation](https://www.typescriptlang.org/)
- [mmlabc-to-smf-rust Repository](https://github.com/cat2151/mmlabc-to-smf-rust)
- [mmlabc-to-smf-rust Demo README](https://github.com/cat2151/mmlabc-to-smf-rust/blob/main/demo/README.md)
- [web-tree-sitter Documentation](https://github.com/tree-sitter/tree-sitter/tree/master/lib/binding_web)
