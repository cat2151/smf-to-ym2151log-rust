# issue 調査。ym2151-tone-editorのMMLプレビュー機能用に、「smfバイナリ」と「音色データ」を引数で受け取る仕組みを整理してPRコメントに書く #45
[issues #45](https://github.com/cat2151/smf-to-ym2151log-rust/issues/45)

## 調査結果 / Investigation Results

### 現在のAPI / Current API

#### 1. SMFバイナリの受け取り / Receiving SMF Binary

**既に対応済み** - `convert_smf_to_ym2151_log` 関数がSMFバイナリを `&[u8]` として受け取ることができます。

```rust
// src/lib.rs
pub fn convert_smf_to_ym2151_log(smf_data: &[u8]) -> Result<String>
```

また、低レベルAPIとして `parse_midi_from_bytes` も利用可能です：

```rust
// src/midi/parser.rs
pub fn parse_midi_from_bytes(data: &[u8]) -> Result<MidiData>
```

#### 2. 音色データの受け取り / Receiving Tone Data

**現在の実装**: ファイルから読み込む方式のみ対応

```rust
// src/ym2151/tone.rs
pub fn load_tone_for_program(program: u8) -> Result<Option<ToneDefinition>>
// → tones/{program:03}.json からファイルを読み込む
```

### 提案する拡張API / Proposed Extended API

ym2151-tone-editor の MML プレビュー機能のために、以下のAPIを追加することを提案します。

#### Option A: ToneProvider trait を使用

```rust
/// Trait for providing tone definitions
pub trait ToneProvider {
    /// Get tone definition for a program number
    fn get_tone(&self, program: u8) -> Option<ToneDefinition>;
}

/// Default provider that loads from files
pub struct FileToneProvider;

impl ToneProvider for FileToneProvider {
    fn get_tone(&self, program: u8) -> Option<ToneDefinition> {
        load_tone_for_program(program).ok().flatten()
    }
}

/// In-memory provider for direct tone data
pub struct InMemoryToneProvider {
    tones: HashMap<u8, ToneDefinition>,
}

impl InMemoryToneProvider {
    pub fn new() -> Self {
        Self { tones: HashMap::new() }
    }
    
    pub fn set_tone(&mut self, program: u8, tone: ToneDefinition) {
        self.tones.insert(program, tone);
    }
}

impl ToneProvider for InMemoryToneProvider {
    fn get_tone(&self, program: u8) -> Option<ToneDefinition> {
        self.tones.get(&program).cloned()
    }
}
```

#### Option B: シンプルな拡張関数 (推奨)

より単純なアプローチとして、音色データを直接引数で渡せる関数を追加：

```rust
/// Convert SMF to YM2151 log with custom tone data
///
/// # Arguments
/// * `smf_data` - Raw Standard MIDI File data as bytes
/// * `tones` - Map of program number to tone definition
///
/// # Returns
/// YM2151 register log as JSON string
pub fn convert_smf_to_ym2151_log_with_tones(
    smf_data: &[u8],
    tones: &HashMap<u8, ToneDefinition>,
) -> Result<String>
```

### 使用例 / Usage Example

```rust
use smf_to_ym2151log::convert_smf_to_ym2151_log_with_tones;
use smf_to_ym2151log::ym2151::{ToneDefinition, Ym2151Event};
use std::collections::HashMap;

// SMFバイナリ（例：MMLからコンパイルしたもの）
let smf_data: &[u8] = &[/* SMF binary data */];

// 音色データを直接作成
let tone = ToneDefinition {
    events: vec![
        Ym2151Event { time: 0.0, addr: "0x20".to_string(), data: "0xC7".to_string() },
        // ... other register writes
    ],
};

let mut tones = HashMap::new();
tones.insert(0, tone);  // Program 0 に音色を設定

// 変換実行
let ym2151_json = convert_smf_to_ym2151_log_with_tones(smf_data, &tones)?;
```

### ym2151-tone-editor との連携 / Integration with ym2151-tone-editor

MMLプレビュー機能での利用フロー：

1. **MML → SMF変換**: cat-play-mml などでMMLをSMFバイナリに変換
2. **音色エディターから音色データ取得**: YM2151レジスタ設定をToneDefinitionに変換
3. **変換実行**: `convert_smf_to_ym2151_log_with_tones(smf_data, &tones)`
4. **結果をプレビュー**: 出力されたYM2151ログJSONをym2151-zig-ccで再生

### ToneDefinition の構造 / ToneDefinition Structure

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToneDefinition {
    pub events: Vec<Ym2151Event>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Ym2151Event {
    pub time: f64,     // 通常は0.0（適用時に上書きされる）
    pub addr: String,  // "0x20" 形式
    pub data: String,  // "0xC7" 形式
}
```

### 実装の優先度 / Implementation Priority

1. **Phase 1**: `convert_smf_to_ym2151_log_with_tones` 関数の追加（Option B）
2. **Phase 2**: 必要に応じて ToneProvider trait を追加（Option A）

Option B のシンプルなアプローチを先に実装し、より柔軟な設計が必要になった場合に Option A に拡張することを推奨します。

### 変更が必要なファイル / Files to Modify

1. `src/lib.rs` - 新しいパブリックAPI関数を追加
2. `src/ym2151/converter.rs` - 音色プロバイダを引数として受け取るように拡張
3. `src/ym2151/event_processor.rs` - `process_program_change` を音色マップ対応に
4. テストファイル - 新APIのテストを追加

### 備考 / Notes

- 現在の `convert_smf_to_ym2151_log` は後方互換性のために維持
- `ToneDefinition` は既に `Serialize`/`Deserialize` を実装しているため、JSONからの読み込みも容易
- WebAssembly対応を考慮する場合、ファイルI/Oに依存しないAPIが有用
